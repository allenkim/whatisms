<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin â€” District 2 Dashboard</title>
    <link rel="stylesheet" href="/static/css/pages.css">
    <style>
        .container { max-width: 960px; }
        h2 { font-size: 1.1rem; font-weight: 600; color: #f0f6fc; margin-bottom: 16px; }
        .add-user-form {
            background: #161b22; border: 1px solid #30363d; border-radius: 10px;
            padding: 24px; margin-bottom: 32px;
        }
        .form-row { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end; margin-bottom: 12px; }
        .form-field { flex: 1; min-width: 140px; }
        .checkbox-group { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
        .checkbox-group label {
            display: flex; align-items: center; gap: 6px;
            font-size: 0.875rem; color: #c9d1d9; cursor: pointer;
        }
        .checkbox-group input[type="checkbox"] { accent-color: #4f8ff7; width: 15px; height: 15px; }
        .edit-projects-row td { padding: 8px 14px; background: #0d1117; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Admin Panel</h1>
        <a href="/">&larr; Back to Portal</a>
    </div>
    <div class="container">
        <div class="msg msg-error" id="msg-error"></div>
        <div class="msg msg-success" id="msg-success"></div>

        <h2>Add User</h2>
        <div class="add-user-form">
            <form id="add-user-form">
                <div class="form-row">
                    <div class="form-field">
                        <label for="new-username">Username</label>
                        <input type="text" id="new-username" required>
                    </div>
                    <div class="form-field">
                        <label for="new-password">Password</label>
                        <input type="password" id="new-password" required>
                    </div>
                    <div class="form-field" style="max-width:140px">
                        <label for="new-role">Role</label>
                        <select id="new-role">
                            <option value="user">User</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label>Project Access</label>
                        <div class="checkbox-group" id="new-user-projects"></div>
                    </div>
                    <button type="submit" class="btn btn-primary">Create User</button>
                </div>
            </form>
        </div>

        <h2>Users</h2>
        <table>
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Role</th>
                    <th>Projects</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="users-tbody">
                <tr><td colspan="5" class="loading"><span class="spinner"></span>Loading users...</td></tr>
            </tbody>
        </table>

        <h2>Projects</h2>
        <table>
            <thead>
                <tr>
                    <th>Slug</th>
                    <th>Name</th>
                    <th>Path</th>
                    <th>Active</th>
                </tr>
            </thead>
            <tbody id="projects-tbody">
                <tr><td colspan="4" class="loading"><span class="spinner"></span>Loading projects...</td></tr>
            </tbody>
        </table>
    </div>

    <script>
        let allProjects = [];
        let allUsers = [];

        async function loadData() {
            const [usersResp, projectsResp] = await Promise.all([
                fetch('/admin/api/users'),
                fetch('/admin/api/projects'),
            ]);
            if (!usersResp.ok || !projectsResp.ok) {
                showError('Failed to load data');
                return;
            }
            allUsers = await usersResp.json();
            allProjects = await projectsResp.json();
            renderUsers();
            renderProjects();
            renderNewUserProjects();
        }

        function renderUsers() {
            const tbody = document.getElementById('users-tbody');
            tbody.innerHTML = '';
            for (const u of allUsers) {
                const tr = document.createElement('tr');
                const projectNames = u.project_ids
                    .map(pid => allProjects.find(p => p.id === pid))
                    .filter(Boolean)
                    .map(p => `<span class="badge badge-project">${esc(p.name)}</span>`)
                    .join(' ');
                const roleBadge = u.role === 'admin'
                    ? '<span class="badge badge-admin">admin</span>'
                    : '<span class="badge badge-user">user</span>';
                const adminNote = u.role === 'admin' ? ' <span style="color:#8b949e;font-size:0.75rem">(all)</span>' : '';
                tr.innerHTML = `
                    <td>${esc(u.username)}</td>
                    <td>${roleBadge}</td>
                    <td>${projectNames}${adminNote}</td>
                    <td style="color:#8b949e">${u.created_at ? u.created_at.split('T')[0] : ''}</td>
                    <td>
                        <button class="btn-sm edit-projects-btn" data-user-id="${u.id}">Edit Projects</button>
                        <button class="btn-sm danger delete-user-btn" data-user-id="${u.id}" data-username="${esc(u.username)}">Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
                // Hidden edit row
                const editTr = document.createElement('tr');
                editTr.className = 'edit-projects-row';
                editTr.id = `edit-row-${u.id}`;
                editTr.style.display = 'none';
                const checkboxes = allProjects.map(p => {
                    const checked = u.project_ids.includes(p.id) ? 'checked' : '';
                    return `<label><input type="checkbox" value="${p.id}" ${checked}> ${esc(p.name)}</label>`;
                }).join(' ');
                editTr.innerHTML = `<td colspan="5">
                    <div style="display:flex;align-items:center;gap:16px">
                        <span style="font-size:0.8rem;color:#8b949e">Assign projects:</span>
                        <div class="checkbox-group">${checkboxes}</div>
                        <button class="btn-sm save save-projects-btn" data-user-id="${u.id}">Save</button>
                    </div>
                </td>`;
                tbody.appendChild(editTr);
            }

            // Attach event listeners
            tbody.querySelectorAll('.edit-projects-btn').forEach(btn => {
                btn.addEventListener('click', () => toggleEditProjects(parseInt(btn.dataset.userId)));
            });
            tbody.querySelectorAll('.delete-user-btn').forEach(btn => {
                btn.addEventListener('click', () => deleteUser(parseInt(btn.dataset.userId), btn.dataset.username));
            });
            tbody.querySelectorAll('.save-projects-btn').forEach(btn => {
                btn.addEventListener('click', () => saveUserProjects(parseInt(btn.dataset.userId)));
            });
        }

        function renderProjects() {
            const tbody = document.getElementById('projects-tbody');
            tbody.innerHTML = '';
            for (const p of allProjects) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${esc(p.slug)}</td>
                    <td>${esc(p.name)}</td>
                    <td style="color:#8b949e">${esc(p.path)}</td>
                    <td>${p.is_active ? '<span style="color:#3fb950">Yes</span>' : '<span style="color:#f85149">No</span>'}</td>
                `;
                tbody.appendChild(tr);
            }
        }

        function renderNewUserProjects() {
            const container = document.getElementById('new-user-projects');
            container.innerHTML = '';
            for (const p of allProjects) {
                const label = document.createElement('label');
                label.innerHTML = `<input type="checkbox" name="project" value="${p.id}"> ${esc(p.name)}`;
                container.appendChild(label);
            }
        }

        function toggleEditProjects(userId) {
            const row = document.getElementById(`edit-row-${userId}`);
            row.style.display = row.style.display === 'none' ? '' : 'none';
        }

        async function saveUserProjects(userId) {
            const row = document.getElementById(`edit-row-${userId}`);
            const btn = row.querySelector('.save');
            btn.disabled = true;
            btn.textContent = 'Saving...';
            const checked = Array.from(row.querySelectorAll('input[type="checkbox"]:checked'))
                .map(cb => parseInt(cb.value));
            try {
                const resp = await fetch(`/admin/api/users/${userId}/projects`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ project_ids: checked }),
                });
                if (resp.ok) {
                    showSuccess('Projects updated');
                    await loadData();
                } else {
                    showError('Failed to update projects');
                }
            } finally {
                btn.disabled = false;
                btn.textContent = 'Save';
            }
        }

        async function deleteUser(userId, username) {
            if (!confirm(`Delete user "${username}"? This cannot be undone.`)) return;
            const resp = await fetch(`/admin/api/users/${userId}`, { method: 'DELETE' });
            if (resp.ok) {
                showSuccess(`User "${username}" deleted`);
                await loadData();
            } else {
                const data = await resp.json();
                showError(data.error || 'Failed to delete user');
            }
        }

        document.getElementById('add-user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('.btn-primary');
            btn.disabled = true;
            btn.textContent = 'Creating...';
            const projectIds = Array.from(
                document.querySelectorAll('#new-user-projects input[type="checkbox"]:checked')
            ).map(cb => parseInt(cb.value));

            try {
                const resp = await fetch('/admin/api/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: document.getElementById('new-username').value,
                        password: document.getElementById('new-password').value,
                        role: document.getElementById('new-role').value,
                        project_ids: projectIds,
                    }),
                });
                if (resp.ok) {
                    showSuccess('User created');
                    document.getElementById('add-user-form').reset();
                    await loadData();
                } else {
                    const data = await resp.json();
                    showError(data.error || 'Failed to create user');
                }
            } finally {
                btn.disabled = false;
                btn.textContent = 'Create User';
            }
        });

        function showError(msg) {
            const el = document.getElementById('msg-error');
            el.textContent = msg;
            el.style.display = 'block';
            document.getElementById('msg-success').style.display = 'none';
            setTimeout(() => el.style.display = 'none', 5000);
        }

        function showSuccess(msg) {
            const el = document.getElementById('msg-success');
            el.textContent = msg;
            el.style.display = 'block';
            document.getElementById('msg-error').style.display = 'none';
            setTimeout(() => el.style.display = 'none', 5000);
        }

        function esc(s) {
            if (!s) return '';
            const d = document.createElement('div');
            d.textContent = s;
            return d.innerHTML;
        }

        loadData();
    </script>
</body>
</html>

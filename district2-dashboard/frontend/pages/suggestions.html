<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suggestions â€” Whatisms</title>
    <link rel="stylesheet" href="/static/css/pages.css">
    <style>
        .submit-section {
            background: #161b22; border: 1px solid #30363d; border-radius: 10px;
            padding: 24px; margin-bottom: 32px;
        }
        .submit-section h2 { font-size: 1rem; color: #f0f6fc; margin-bottom: 12px; }
        .submit-section textarea {
            width: 100%; min-height: 100px; padding: 12px;
            background: #0d1117; border: 1px solid #30363d; border-radius: 6px;
            color: #e1e4e8; font-family: inherit; font-size: 0.95rem;
            resize: vertical; outline: none;
        }
        .submit-section textarea:focus { border-color: #4f8ff7; }
        .submit-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        .char-count { font-size: 0.8rem; color: #8b949e; }
        .char-count.warn { color: #f0883e; }
        .btn-submit {
            background: #4f8ff7; border: none; color: #fff; padding: 8px 20px;
            border-radius: 6px; font-size: 0.875rem; cursor: pointer; transition: background 0.2s;
        }
        .btn-submit:hover { background: #3a7be0; }
        .btn-submit:disabled { opacity: 0.5; cursor: not-allowed; }
        .suggestions-list h2 { font-size: 1rem; color: #8b949e; margin-bottom: 16px; font-weight: 400; }
        td { vertical-align: top; }
        tr.expandable { cursor: pointer; }
        tr.expandable:hover td { background: #161b22; }
        .suggestion-text { max-width: 350px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .detail-row td { padding: 0; border-bottom: 1px solid #30363d; }
        .detail-content { padding: 16px 12px; background: #161b22; }
        .detail-content h4 { font-size: 0.8rem; color: #8b949e; margin-bottom: 6px; font-weight: 500; }
        .detail-content p { white-space: pre-wrap; word-break: break-word; margin-bottom: 16px; line-height: 1.5; }
        .detail-content pre {
            background: #0d1117; border: 1px solid #30363d; border-radius: 6px;
            padding: 12px; overflow-x: auto; font-size: 0.8rem; line-height: 1.5;
            white-space: pre-wrap; word-break: break-word;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Suggestions</h1>
        <div class="header-actions">
            <span id="user-display"></span>
            <a href="/">Back to Portal</a>
            <button class="btn-danger" id="signout-btn">Sign Out</button>
        </div>
    </div>
    <div class="container">
        <div class="submit-section">
            <h2>Submit a Suggestion</h2>
            <textarea id="suggestion-input" maxlength="5000" placeholder="Describe a change you'd like to see on the site..."></textarea>
            <div class="submit-footer">
                <span class="char-count" id="char-count">0 / 5000</span>
                <button class="btn-submit" id="submit-btn">Submit</button>
            </div>
            <div class="submit-msg" id="submit-msg"></div>
        </div>
        <div class="suggestions-list">
            <h2>All Suggestions</h2>
            <table>
                <thead>
                    <tr>
                        <th>Suggestion</th>
                        <th>Status</th>
                        <th>Submitted By</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody id="suggestions-body">
                    <tr><td colspan="4" class="loading"><span class="spinner"></span>Loading suggestions...</td></tr>
                </tbody>
            </table>
            <div class="empty-state" id="empty-state" style="display:none;">No suggestions yet. Be the first!</div>
        </div>
    </div>

    <script>
        const input = document.getElementById('suggestion-input');
        const charCount = document.getElementById('char-count');
        const submitBtn = document.getElementById('submit-btn');
        const msgEl = document.getElementById('submit-msg');

        input.addEventListener('input', () => {
            const len = input.value.length;
            charCount.textContent = len + ' / 5000';
            charCount.classList.toggle('warn', len > 4500);
        });

        submitBtn.addEventListener('click', async () => {
            const text = input.value.trim();
            if (!text) return;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';
            msgEl.style.display = 'none';
            try {
                const resp = await fetch('/api/suggestions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ suggestion_text: text }),
                });
                if (!resp.ok) {
                    const data = await resp.json();
                    throw new Error(data.error || 'Failed to submit');
                }
                input.value = '';
                charCount.textContent = '0 / 5000';
                msgEl.className = 'submit-msg success';
                msgEl.textContent = 'Suggestion submitted!';
                msgEl.style.display = 'block';
                loadSuggestions();
            } catch (err) {
                msgEl.className = 'submit-msg error';
                msgEl.textContent = err.message;
                msgEl.style.display = 'block';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit';
            }
        });

        document.getElementById('signout-btn').addEventListener('click', async () => {
            await fetch('/auth/logout', { method: 'POST' });
            window.location.href = '/login';
        });

        let expanded = {};

        async function loadSuggestions() {
            try {
                const resp = await fetch('/api/suggestions');
                if (!resp.ok) return;
                const data = await resp.json();
                const tbody = document.getElementById('suggestions-body');
                const empty = document.getElementById('empty-state');

                if (data.length === 0) {
                    tbody.innerHTML = '';
                    empty.style.display = 'block';
                    return;
                }
                empty.style.display = 'none';

                let html = '';
                for (const s of data) {
                    const isOpen = expanded[s.id];
                    html += `<tr class="expandable" data-id="${s.id}">
                        <td class="suggestion-text">${esc(s.suggestion_text)}</td>
                        <td><span class="badge badge-${s.status}">${esc(s.status)}</span></td>
                        <td>${esc(s.username)}</td>
                        <td>${formatDate(s.created_at)}</td>
                    </tr>`;
                    html += `<tr class="detail-row" id="detail-${s.id}" style="display:${isOpen ? 'table-row' : 'none'}">
                        <td colspan="4">
                            <div class="detail-content">
                                <h4>Full Suggestion</h4>
                                <p>${esc(s.suggestion_text)}</p>
                                ${s.claude_output ? `<h4>Claude Output</h4><pre>${esc(s.claude_output)}</pre>` : ''}
                                ${s.processed_at ? `<h4>Processed</h4><p>${formatDate(s.processed_at)}</p>` : ''}
                            </div>
                        </td>
                    </tr>`;
                }
                tbody.innerHTML = html;

                // Attach click listeners for expanding rows
                tbody.querySelectorAll('.expandable').forEach(tr => {
                    tr.addEventListener('click', () => {
                        const id = tr.dataset.id;
                        expanded[id] = !expanded[id];
                        const row = document.getElementById('detail-' + id);
                        if (row) row.style.display = expanded[id] ? 'table-row' : 'none';
                    });
                });
            } catch (err) {
                console.error('Failed to load suggestions:', err);
            }
        }

        function formatDate(iso) {
            if (!iso) return '';
            const d = new Date(iso + 'Z');
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
        }

        function esc(s) {
            if (!s) return '';
            const d = document.createElement('div');
            d.textContent = s;
            return d.innerHTML;
        }

        async function init() {
            const resp = await fetch('/auth/me');
            if (!resp.ok) { window.location.href = '/login'; return; }
            const data = await resp.json();
            document.getElementById('user-display').textContent = data.user.username;
            loadSuggestions();
            setInterval(loadSuggestions, 10000);
        }

        init();
    </script>
</body>
</html>
